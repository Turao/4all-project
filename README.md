# 4all-project

---
## Overview

- Python Version: 3.7.2
- Docker version 18.06.1-ce, build e68fc7a

---
## How-to's:
### Python Virtual Environment
To avoid versioning issues, you should activate the project's virtual environment.
- _cd_ to the app directory: i.e. `cd 4all-project/`
- Activate the environment:
  - if using bash/zsh `source ./bin/activate`
  - the command for other shells (fish/csh/tcsh) can be found at https://docs.python.org/3/library/venv.html

### Docker PostgreSQL
To speed things up, I've decided to run the PostgreSQL database into a docker container.
In case you do not have Docker installed in your machine, please follow the instructions at https://docs.docker.com/install/ 

To setup the container, run the following command: `sudo docker run --name 4all-postgresql -e POSTGRES_PASSWORD=14all41 -e POSTGRES_DB=4all-db-dev -e POSTGRES_USER=4all-user -p 5432:5432 -d postgres`

This may take a while, since it might have to download the PostgreSQL image from the Docker Hub.

Other commands you might find useful:
- Following the logs generated by the image, run: `sudo docker logs --follow 4all-postgresql`
- Starting the container: `sudo docker start 4all-postgresql`
- Show containers and their statuses: `sudo docker ps`
- Stopping the container: `sudo docker stop 4all-postgresql`
- Removing the container: `sudo rm 4all-postgresql`

### Environment Variables
#### Postgres

- `export DB_NAME=4all-db-dev`

- `export DB_HOST=localhost`
- `export DB_PORT=5432`

- `export DB_USER=4all-user`
- `export DB_PASSWORD=14all41`

- `export DB_POOL_MAX_CONNECTIONS=32`
- `export DB_POOL_TIMEOUT=300`

#### OpenCageAPI
- `export OPENCAGE_KEY=[your_app_key_here]`


### Configuring ulimit:
If you want to send a high amount of requests, you might have to increase the limit of files that can be opened simultaneously (since each request opens a file descriptor).

To make things easier, we'll set both HARD and SOFT limits to the same value...

- First, we'll ask for PAM to set some rules for us (use _optional_ instead of _required_, otherwise you might mistype the limit rule and be unable to log in)
  - Add the line `session optional pam_limits.so` to the following files:
    - `/etc/pam.d/common-session`
    - `/etc/pam.d/common-session-noninteractive`

- Then, add the limit rules to the config file `/etc/security/limits.conf`
  - Add the line `* soft nofile 10240`
  - Add the line `* hard nofile 10240`

- Log out
- Log in

- Finally, check your SOFT limit by running `ulimit -n` in the terminal

##### Troubleshooting:
- The limit did not change:
  - (a bit hacky) try to `su [your_user_here]` and run the command again, execute the program from this shell
  - check for typos in your limit rules
  - check if PAM is enabled and calling limits.so

More about _limits.conf_ and _pam.d_ can be found at:
- https://linux.die.net/man/5/limits.conf
- https://linux.die.net/man/5/pam.d


### Running the Parser:
To execute the parsing module, run the following command: `python -m datapoints.parser.location_parser [your_dataset_here]`
